# DPS 기능 명세

## 목적

OverlayTimer에서 전투 중 실시간 DPS와 대상별 데미지, 스킬별 데미지 비중/비율 통계를 표시한다.
게임 클라이언트에는 송신하지 않고 패킷 캡처(읽기)만 사용한다.

---

## 현재 구현 상태 요약

- DPS는 항상 측정 상태로 동작한다.
- 초기화 버튼으로 누적값/시간/통계를 수동 초기화한다.
- selfId가 이전과 다른 값으로 변경될 때만 DPS를 자동 초기화한다 (같은 ID 재수신은 무시).
- 전투가 멈춘 뒤에는 분모 시간을 마지막 데미지 수신 시각으로 고정해 DPS가 계속 하락하지 않는다.

---

## 핵심 패킷 기준

### 1) ATTACK 메타 패킷: 20389

- 길이: 35 bytes
- 필드:
  - 0..3: userId
  - 8..11: targetId
  - 16..19: key1 <- 스킬 타입 ID로 활용
  - 20..23: key2
  - 24..30: flags(7 bytes)

### 2) DAMAGE 값 패킷: 20897

- 길이: 관측상 53 bytes (앞 39 bytes는 self-damage 구조와 동일)
- 필드:
  - 0..3: userId
  - 8..11: targetId
  - 16..19: damage
  - 32..38: flags(7 bytes)

### 3) 매칭 규칙

- 20897 수신 시 pending 큐에 저장
- 직후(유효 시간 내) 20389 수신 시 아래 3개가 모두 같으면 1건으로 매칭:
  - userId
  - targetId
  - flags(7 bytes)
- 매칭 성공 시 20897.damage를 최종 데미지로 누적
- selfId가 존재할 경우 내 캐릭터 userId만 반영

---

## 플래그 비트 정의 (가설)

매칭된 ATTACK 패킷의 flags 필드에서 추출. 스킬별 통계에 반영된다.

| 항목 | 비트 |
|---|---|
| 크리티컬 | flags[0] & 0x01 |
| 강타 | flags[1] & 0x02 |
| 연타 | flags[1] & 0x04 |
| 추가타 | flags[3] & 0x08 |

---

## 스킬 타입별 통계

### 스킬 타입 식별자

- ATTACK 패킷(20389)의 key1 필드(bytes 16..19)를 스킬 타입 ID로 사용한다.
- key1이 0인 경우 flags 기반으로 임시 분류한다:
  - dot_flag 계열(0x08/0x80/0x01/0x10): 지속피해
    - fire_flag(0x40): 지속피해(화염)
    - ice_flag(0x01): 지속피해(빙결)
    - electric_flag(0x02): 지속피해(전기)
    - poison_flag(0x04): 지속피해(중독)
    - holy_flag(0x80): 지속피해(신성)
    - dark_flag(0x20): 지속피해(암흑)
    - bleed_flag(0x10): 지속피해(출혈)
    - mind_flag(0x08): 지속피해(정신)
    - 2개 이상 동시 세트: 지속피해(복합)
  - add_hit_flag(0x08): 추가 타격
  - 그 외: 평타
- skill_names.json에 ID -> 이름 매핑을 추가하면 스킬 이름으로 표시된다. 매핑이 없으면 숫자 ID 그대로 표시.

### 누적 규칙

- 매칭 성공 1건(=1타)마다 해당 key1 값에 대해 아래를 누적:
  - 데미지 합산
  - 타수(hitCount) +1
  - 크리티컬/추가타/강타/연타 카운터

### 표시 항목 (스킬별)

| 항목 | 계산식 |
|---|---|
| 데미지 비중 | 스킬 누적 데미지 / 총 누적 데미지 * 100 |
| 크리티컬률 | 스킬 크리티컬 수 / 스킬 타수 * 100 |
| 추가타율 | 스킬 추가타 수 / (스킬 타수 - 스킬 추가타 수) * 100 |
| 강타율 | 스킬 강타 수 / 스킬 타수 * 100 |
| 연타율 | 스킬 연타 수 / 스킬 타수 * 100 |

- 목록은 데미지 비중 내림차순 정렬.

---

## DPS 계산식

총 DPS = 총 누적 데미지 / (마지막 데미지 시각 - 첫 데미지 수신 시각)

대상별 DPS = 대상 누적 데미지 / (마지막 데미지 시각 - 첫 데미지 수신 시각)

주의:
- 시작 시각은 초기화(또는 앱 시작) 후 첫 데미지 패킷이 수신된 시각으로 설정된다.
  - 이전 방식(초기화 즉시 시작)과 달리, 전투 전 대기 시간이 경과 시간에 포함되지 않는다.
- 전투가 멈췄을 때는 마지막 데미지 시각이 고정되므로 DPS도 고정된다.
- 초기화 또는 selfId 변경 시 시작 시각과 누적값이 리셋된다.

---

## UI / 조작

### DPS 오버레이

- 기본 표시: 총 DPS, 총 누적 데미지, 경과 시간
- 버튼:
  - 초기화: 누적/시간/대상별/스킬별 값 초기화
  - 대상별 데미지: 대상별 DPS 목록 패널 토글
  - 스킬별 통계: 스킬 타입별 데미지 비중 및 플래그 비율 패널 토글

### 스킬별 통계 패널 행 형식

[스킬이름 또는 Skill ID]   [비중%]  ([타수]타)
크리:[x%]  추가:[x%]  강타:[x%]  연타:[x%]

### 대상 선택 필터

- 대상별 데미지 패널의 항목을 클릭하면 해당 대상이 선택/해제(토글)된다.
- 여러 대상을 동시에 선택할 수 있다 (다중 선택).
- 선택된 대상이 있을 때는 스킬별 통계 패널이 해당 대상(들)에게 가한 데미지 기준으로 표시된다.
  - 다중 선택 시 선택된 대상 전체의 스킬 통계를 합산한다.
  - 데미지 비중은 선택된 대상 전체 누적 데미지 대비 스킬별 비중으로 계산한다.
- 선택이 없는 기본 상태에서는 전체 누적 데미지 기준으로 스킬별 통계를 표시한다.
- 선택된 항목은 시각적으로 강조(하이라이트) 표시된다.
- 스킬별 통계 패널 헤더에 현재 필터 상태가 표시된다:
  - 전체: "스킬별 통계"
  - 1개 선택: "스킬별 통계 (Target {ID} 한정)"
  - N개 선택: "스킬별 통계 (N개 대상 한정)"

---

## 공통 운영/설정

아래 항목은 DPS 전용이 아닌 공통 동작이므로 별도 문서로 분리했다.

- 트레이 아이콘 메뉴 동작
- 오버레이 공통 입력(드래그/클릭 투과)
- `config.json`의 공통 설정 포인트
- 이름 매핑 파일(`skill_names.json`) 형식

자세한 내용은 `OVERLAY_OPERATION.md` 참고.

---

## 관련 구현 파일

- Net/PacketAttack20389.cs
- Net/PacketDamage20897.cs
- Net/PacketHandler.cs
- Net/DpsTracker.cs
- DpsOverlayWindow.xaml
- DpsOverlayWindow.xaml.cs
- App.xaml.cs
- AppConfig.cs (SkillNameMap 포함)
- config.json
- skill_names.json

---

## 현재 한계 / TODO

- 플래그 의미(특히 강타, 연타)는 추가 표본으로 계속 검증 필요
- 스킬 타입 ID(key1) 값 수집 후 skill_names.json에 이름 매핑 추가 필요
- DOT 세부 타입 플래그 해석 정확도(복합 플래그 포함) 검증 필요
- 보스/일반 대상 구분 표시는 추후 확장 항목

