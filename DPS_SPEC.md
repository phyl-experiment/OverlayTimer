# DPS 표시기 기능 명세

## 개요

기존 각성 버프 타이머 오버레이와 동일한 스타일로, 초당 데미지(DPS)를 실시간으로 표시하는 오버레이 UI를 추가한다.

---

## UI 구성

### 메인 DPS 오버레이

- 타이머 오버레이와 유사한 크기와 형태의 독립적인 오버레이 창
- 기본 표시: **총 DPS** (넣은 총 데미지 ÷ 경과 시간)
- 수치 표시 형식: **만 단위, 소수점 첫째 자리**
  - 예) `1234567` → `123.5만`
- 토글 버튼(▼/▲)을 눌러 **대상별 DPS 목록**을 아래쪽으로 펼칠 수 있음
  - 목록은 **스크롤 가능**한 형태
  - 각 항목: `대상 ID` + `해당 대상에 대한 DPS` (보스 여부 표시는 선택적 확장)
  - 접으면 메인 수치만 표시하는 컴팩트 형태로 복귀

### 측정 상태 표시

| 상태 | 표시 |
|---|---|
| 측정 중 | 정상 DPS 수치 표시 |
| 측정 중지 | 수치 고정(마지막 값 유지) + 중지 표시 |

---

## 조작

| 동작 | 효과 |
|---|---|
| **Ctrl + 좌클릭 드래그** | DPS 오버레이 창 이동 (타이머와 독립적) |
| **Ctrl + 우클릭** | DPS 측정 시작 / 중지 토글 |
| **토글 버튼 클릭** | 대상별 DPS 목록 펼치기 / 접기 |

> 측정 중지 후 다시 시작하면 누적 데미지와 경과 시간이 **초기화**되고 새로 측정 시작. (Ctrl+우클릭과 동일한 동작)

---

## config.json 연동

`config.json`에 각 오버레이의 활성화 여부 및 초기 위치를 설정 가능.

```json
"overlays": {
  "timer": {
    "enabled": true,
    "x": 100,
    "y": 100
  },
  "dps": {
    "enabled": true,
    "x": 200,
    "y": 200
  }
}
```

- `timer.enabled` / `dps.enabled`: 각 오버레이를 독립적으로 활성화/비활성화
- 두 오버레이 모두 활성화하거나 하나만 활성화하는 것 모두 지원
- 위치는 런타임 중 드래그 이동 시 **config.json에 자동 저장**

---

## 패킷 캡처 / 데미지 파싱

### 캡처 경로

- 기존 SnifferService(포트 16000)와 **동일한 캡처 파이프라인** 공유
- `PacketHandler`에서 데미지 관련 패킷 타입을 추가로 분기 처리

### 데미지 패킷 식별 (미확정 — 구현 시 확인 필요)

> **TODO**: 게임 클라이언트와 서버 간 실제 패킷을 덤프/분석하여 데미지 패킷의 `dataType` 번호 및 페이로드 구조를 확인해야 함.

확인이 필요한 항목:
- 데미지 패킷의 `dataType` 값
- 페이로드 내 필드 레이아웃 (공격자 ID, 대상 ID, 데미지 값 위치 등)
- 미스/회피/크리티컬 등 플래그 필드 존재 여부
- 복수 타격이 하나의 패킷에 묶이는지 여부

식별 방법:
1. `PacketDumper`(또는 로그)를 활용해 전투 중 패킷 덤프 수집
2. 데미지 수치와 대응되는 패킷 패턴 분석
3. `dataType` 및 구조 확정 후 `config.json`의 `packetTypes`에 추가

### DPS 계산 로직

```
DPS = 측정 시작 이후 총 데미지 합산 / 경과 시간(초)
대상별 DPS = 해당 대상에게 넣은 데미지 합산 / 경과 시간(초)
```

- 측정 시작 시점부터 경과 시간 카운트
- 데미지 패킷 수신 시 즉시 합산 → UI 주기적 갱신(예: 500ms마다)
- 측정 중지 시 계산 동결, 재시작 시 초기화

---

## 구현 파일 계획 (예정)

| 파일 | 역할 |
|---|---|
| `DpsOverlayWindow.xaml/.cs` | DPS 오버레이 UI 창 |
| `Net/DpsTracker.cs` | 데미지 누적 및 DPS 계산 |
| `Net/PacketDamage.cs` | 데미지 패킷 구조체 파서 |
| `AppConfig.cs` 수정 | `overlays` 섹션 추가 |
| `Net/PacketHandler.cs` 수정 | 데미지 패킷 분기 추가 |
| `App.xaml.cs` 수정 | DPS 오버레이 조건부 생성 |

---

## 미결 사항

- [ ] 데미지 패킷 `dataType` 및 페이로드 구조 확인 (구현 초기에 덤프로 분석)
- [ ] 보스 여부 구분 방법 확인 (선택적 확장)
